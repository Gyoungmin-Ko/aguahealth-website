# 퇴방 입력화면 설계 – 엑셀 형태 세부항목 입력

엑셀 템플릿(비목계산)처럼 **원료비·재료비 등을 항목별로 한 줄씩 입력**하도록 UI를 바꾸기 위한 설계입니다.

---

## 1. 왜 입력화면이 따로 필요한가

- **현재**: `aiModules.js`의 `inputs` 배열만으로 공통 폼을 그리므로, "1단위당 원료비(원)" 같은 **이미 합산된 값 하나**만 넣는 형태.
- **목표**: 엑셀처럼 **원료 한 줄마다 구입단가(M)·제조투입량(N)** 입력 → O=M×N → 합계÷인정총생산량 = 1단위당 원료비. 재료비·노무비·경비도 동일한 "세부 항목 입력 → 계산" 흐름.
- **선택**: 다른 AI 모듈은 기존 공통 폼을 쓰고, **퇴방만** 전용 입력 컴포넌트를 두어 "엑셀 형태"를 구현.

---

## 2. 데이터 구조 (제품 국내제조 기준)

전송/상태는 아래처럼 **섹션·배열**로 가져가면 엑셀과 1:1로 맞추기 쉽습니다.

```js
{
  productType: 'product',
  productName: '',
  companyName: '',
  drugCode: '',
  unitSpec: '',
  targetTiming: '',
  approvedProduction: 13510500,   // 인정총생산량 G17 = Q31

  // 원료비: 엑셀 M(구입단가), N(제조투입량) → O=M*N, T31=SUM(O)/Q31
  rawMaterials: [
    { name: '원료1', unitPrice: 6.37, quantity: 375 },
    { name: '원료2', unitPrice: 30.01, quantity: 100 },
    // ...
  ],

  // 재료비: Z(단가), AA(수량) → AB=Z*AA, AG31=SUM(AB)/Q31
  materials: [
    { name: '재료1', unitPrice: 481.35, quantity: 488 },
    // ...
  ],

  // 노무비: AO31 = (AO7/AO8*AO9)/AO10
  labor: {
    productLaborHours: 1711.93,   // AO7 신청제품 노무시간
    totalLaborHours: 71040,      // AO8 총생산 노무시간
    totalLaborCost: 5054810631,  // AO9 노무비
    // AO10 = approvedProduction
  },

  // 경비: BA31 = (BA7/BA8*BA9)/BA10, BA7=AO7, BA8=AO8
  overhead: {
    totalOverhead: 13964975169 - 8267617544 - 151427430, // 제조경비총액−연구개발−무형자산
    // 배분은 노무시간 비율 등
  },

  outsourcingPerUnit: 0,          // 외주가공비 1단위당 (또는 총액/approvedProduction)
  sellingAdminPerUnit: 1.03,     // 판관비 1단위당
  nonOperatingPerUnit: 0.47,     // 영업외 1단위당
  profitRatePercent: 10.712,

  costData: File | null,
  notes: '',
}
```

- **원료비/재료비**: 배열 길이는 가변, "행 추가/삭제"로 엑셀의 7~30행과 동일한 입력 방식.
- **노무비/경비**: 엑셀 수식에 필요한 숫자만 구조화해서 넣고, 1단위당은 API에서 계산.

---

## 3. UI 단위 (컴포넌트 나누기)

| 단위 | 역할 |
|------|------|
| **공통 상단** | 구분(제품/상품), 제품명, 업소명, 약가코드, 규격단위, 지정 희망 시점 |
| **인정총생산량** | 1개 숫자 입력 (원료비·재료비 분모) |
| **원료비 섹션** | 테이블: [원료명(선택)] [구입단가] [제조투입량] [금액=단가×투입량] + "행 추가" / "행 삭제" → 하단에 "원료비 합계", "1단위당 원료비" 표시 |
| **재료비 섹션** | 동일: [재료명(선택)] [단가] [수량] [금액] + 행 추가/삭제 → 합계, 1단위당 |
| **노무비 섹션** | 신청제품 노무시간, 총생산 노무시간, 노무비(총액) 3개 입력 → 1단위당 노무비 = (1/2×3)/인정총생산량 표시 |
| **경비 섹션** | 제조경비(총액 또는 항목별), 노무시간 비율 등 → 1단위당 경비 표시 |
| **외주가공비** | 0 또는 1단위당 입력 |
| **판관비·영업외·적정이윤** | 1단위당 직접 입력 (또는 추후 손익계산서 기반 입력 확장) |
| **첨부·메모** | 기존처럼 파일 1개, 메모 1개 |

이렇게 하면 **엑셀의 "하나하나 입력해서 계산"**과 같은 흐름을 그대로 웹에서 재현할 수 있습니다.

---

## 4. 코드 구조 제안

- **퇴방만 전용 폼 사용**  
  - `moduleId === 'drug-withdrawal-prevention'` 일 때는 기존 `inputs` 기반 공통 폼 대신 **퇴방 전용 컴포넌트**를 렌더링.
- **전용 컴포넌트**  
  - 예: `src/pages/ai/WithdrawalPreventionForm.jsx`  
  - 위 데이터 구조를 state로 갖고, 섹션별로 나눠서 렌더 (공통 → 인정총생산량 → 원료비 테이블 → 재료비 테이블 → 노무비 → 경비 → 외주가공 → 판관비/영업외/적정이윤 → 첨부·메모).
- **재사용 가능한 작은 단위**  
  - "반복 입력 테이블" 하나: `RepeatableCostTable({ rows, onChange, columns, addRowLabel, sumLabel })`  
  - 원료비/재료비는 같은 테이블 컴포넌트를 column 정의만 바꿔서 2번 사용.
- **전송**  
  - 전용 폼에서는 `values`를 그대로 JSON으로 직렬화해 `FormData`에 넣거나, `fetch` body에 JSON으로 보냄.  
  - API는 `rawMaterials`, `materials`, `labor`, `overhead` 등을 받아 **템플릿 수식 해석 문서**대로 T31, AG31, AO31, BA31 → BR31 → 조정신청금액까지 계산.

---

## 5. 구현 순서 제안

1. **원료비·재료비만** 먼저 "엑셀 형태"로 구현  
   - 반복 행 입력 + 합계·1단위당 표시.  
   - 나머지(노무비, 경비 등)는 기존처럼 1단위당 값만 넣는 필드로 두어도 동작하게 유지.
2. API에서 `rawMaterials` / `materials` 배열 수신 시  
   - T31, AG31을 위 수식대로 계산해 제조원가 소계에 반영.
3. 그 다음 **노무비·경비**를 엑셀과 동일한 입력(숫자 몇 개)으로 확장하고, API 수식 완성.
4. 상품(수입)은 별도 블록으로 같은 패턴(세부 항목 입력 → 계산)으로 확장.

이 순서로 가면 기존 동작을 깨지 않으면서, 엑셀과 같은 "세부항목 하나하나 입력" 형태로 점진적으로 바꿀 수 있습니다.
